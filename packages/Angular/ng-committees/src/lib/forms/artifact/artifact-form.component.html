<div class="record-form-container">
    @if (record) {
        <form class="record-form" #form="ngForm">
            <mj-form-toolbar [form]="this"></mj-form-toolbar>

            <!-- ================================================================
                 HERO HEADER
                 ================================================================ -->

            <div class="artifact-hero">
                <div class="hero-background">
                    <div class="gradient-orb orb-1"></div>
                    <div class="gradient-orb orb-2"></div>
                </div>

                <div class="hero-content">
                    <div class="artifact-icon-wrapper">
                        <i [class]="artifactTypeIcon"></i>
                    </div>

                    <div class="artifact-details">
                        <div class="badge-row">
                            @if (record.ArtifactType) {
                                <span class="type-badge">
                                    <i [class]="artifactTypeIcon"></i>
                                    {{ record.ArtifactType }}
                                </span>
                            }
                            @if (record.Provider) {
                                <span class="provider-badge">
                                    <i [class]="providerIconClass"></i>
                                    {{ record.Provider }}
                                </span>
                            }
                            @if (record.FileSize) {
                                <span class="size-badge">
                                    <i class="fas fa-hdd"></i>
                                    {{ fileSizeDisplay }}
                                </span>
                            }
                        </div>

                        <h1 class="artifact-name">
                            {{ record.Title || 'New Artifact' }}
                        </h1>

                        @if (record.Description) {
                            <p class="artifact-description">{{ record.Description }}</p>
                        }

                        @if (record.IsSaved && attachedToDisplay !== 'Not attached') {
                            <div class="quick-stats">
                                <div class="stat">
                                    <i class="fas fa-paperclip"></i>
                                    <span>Attached to {{ attachedToDisplay }}</span>
                                </div>
                            </div>
                        }
                    </div>

                    <div class="hero-actions">
                        @if (EditMode) {
                            <button class="btn-hero btn-save" (click)="SaveRecord(true)">
                                <i class="fas fa-save"></i>
                                <span>Save</span>
                            </button>
                            <button class="btn-hero btn-cancel" (click)="handleCancel()">
                                <i class="fas fa-times"></i>
                                <span>Cancel</span>
                            </button>
                        } @else {
                            <button class="btn-hero btn-edit" (click)="StartEditMode()">
                                <i class="fas fa-edit"></i>
                                <span>Edit</span>
                            </button>
                        }
                    </div>
                </div>
            </div>

            <!-- ========================================================================
                MAIN FORM CONTENT - CARD GRID
                ======================================================================== -->

            <div class="form-content">
                <div class="cards-grid">

                    <!-- Document Info Card -->
                    <div class="info-card" [class.edit-mode]="EditMode">
                        <div class="card-header">
                            <div class="card-icon" style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);">
                                <i class="fas fa-file-alt"></i>
                            </div>
                            <div class="card-title-section">
                                <h3 class="card-title">Document Info</h3>
                                <p class="card-subtitle">Basic artifact information</p>
                            </div>
                        </div>

                        <div class="card-body">
                            <!-- Title -->
                            <div class="form-group" (focusout)="markFieldAsTouched('Title')">
                                <label class="form-label">
                                    <i class="fas fa-heading"></i>
                                    Title
                                    <span class="required">*</span>
                                </label>
                                <mj-form-field
                                    (input)="onFieldInput('Title')"
                                    (keyup)="onFieldInput('Title')"
                                    [record]="record"
                                    [ShowLabel]="false"
                                    FieldName="Title"
                                    Type="textbox"
                                    [EditMode]="EditMode"
                                    [formContext]="formContext">
                                </mj-form-field>
                                @if (shouldShowFieldError('Title')) {
                                    <div class="field-error">
                                        <i class="fas fa-exclamation-circle"></i>
                                        {{ validationErrors.Title }}
                                    </div>
                                }
                            </div>

                            <!-- Description -->
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-align-left"></i>
                                    Description
                                    <span class="optional">(optional)</span>
                                </label>
                                <mj-form-field
                                    [record]="record"
                                    [ShowLabel]="false"
                                    FieldName="Description"
                                    Type="textarea"
                                    [EditMode]="EditMode"
                                    [formContext]="formContext">
                                </mj-form-field>
                            </div>

                            <!-- ArtifactType -->
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-folder"></i>
                                    Artifact Type
                                </label>
                                <mj-form-field
                                    [record]="record"
                                    [ShowLabel]="false"
                                    FieldName="ArtifactType"
                                    Type="dropdownlist"
                                    [EditMode]="EditMode"
                                    [formContext]="formContext">
                                </mj-form-field>
                            </div>
                        </div>
                    </div>

                    <!-- Location & Provider Card -->
                    <div class="info-card" [class.edit-mode]="EditMode">
                        <div class="card-header">
                            <div class="card-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);">
                                <i class="fas fa-link"></i>
                            </div>
                            <div class="card-title-section">
                                <h3 class="card-title">Location & Provider</h3>
                                <p class="card-subtitle">Document source and URL</p>
                            </div>
                        </div>

                        <div class="card-body">
                            <!-- URL -->
                            <div class="form-group" (focusout)="markFieldAsTouched('URL')">
                                <label class="form-label">
                                    <i class="fas fa-globe"></i>
                                    URL
                                    <span class="required">*</span>
                                </label>
                                <mj-form-field
                                    (input)="onFieldInput('URL')"
                                    (keyup)="onFieldInput('URL')"
                                    [record]="record"
                                    [ShowLabel]="false"
                                    FieldName="URL"
                                    Type="textbox"
                                    [EditMode]="EditMode"
                                    [formContext]="formContext">
                                </mj-form-field>
                                @if (shouldShowFieldError('URL')) {
                                    <div class="field-error">
                                        <i class="fas fa-exclamation-circle"></i>
                                        {{ validationErrors.URL }}
                                    </div>
                                }
                                <p class="field-hint">Enter a valid HTTP or HTTPS URL</p>
                            </div>

                            <!-- Provider -->
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-cloud"></i>
                                    Provider
                                </label>
                                <mj-form-field
                                    [record]="record"
                                    [ShowLabel]="false"
                                    FieldName="Provider"
                                    Type="dropdownlist"
                                    [EditMode]="EditMode"
                                    [formContext]="formContext">
                                </mj-form-field>
                            </div>

                            <!-- ExternalID -->
                            <div class="form-group" (focusout)="markFieldAsTouched('ExternalID')">
                                <label class="form-label">
                                    <i class="fas fa-fingerprint"></i>
                                    External ID
                                    @if (record.Provider && record.Provider !== 'URL') {
                                        <span class="required">*</span>
                                    } @else {
                                        <span class="optional">(optional)</span>
                                    }
                                </label>
                                <mj-form-field
                                    (input)="onFieldInput('ExternalID')"
                                    [record]="record"
                                    [ShowLabel]="false"
                                    FieldName="ExternalID"
                                    Type="textbox"
                                    [EditMode]="EditMode"
                                    [formContext]="formContext">
                                </mj-form-field>
                                @if (shouldShowFieldError('ExternalID')) {
                                    <div class="field-error">
                                        <i class="fas fa-exclamation-circle"></i>
                                        {{ validationErrors.ExternalID }}
                                    </div>
                                }
                                <p class="field-hint">Required for cloud providers (Google Drive, SharePoint, etc.)</p>
                            </div>
                        </div>
                    </div>

                    <!-- Associations Card -->
                    <div class="info-card full-width" [class.edit-mode]="EditMode">
                        <div class="card-header">
                            <div class="card-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                                <i class="fas fa-sitemap"></i>
                            </div>
                            <div class="card-title-section">
                                <h3 class="card-title">Associations</h3>
                                <p class="card-subtitle">Link artifact to entities (at least one required)</p>
                            </div>
                        </div>

                        <div class="card-body">
                            @if (shouldShowFieldError('CommitteeID') && !record.CommitteeID && !record.MeetingID && !record.AgendaItemID && !record.ActionItemID) {
                                <div class="info-banner warning">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <p>{{ validationErrors.CommitteeID }}</p>
                                </div>
                            }

                            <div class="associations-grid">
                                <!-- CommitteeID -->
                                <div class="form-group" (focusout)="markFieldAsTouched('CommitteeID')">
                                    <label class="form-label">
                                        <i class="fas fa-users"></i>
                                        Committee
                                    </label>
                                    @if (EditMode) {
                                        <div class="dropdown-wrapper">
                                            @if (isLoadingCommittees) {
                                                <div class="dropdown-loading">
                                                    <i class="fas fa-spinner fa-spin"></i>
                                                    <span>Loading...</span>
                                                </div>
                                            } @else {
                                                <kendo-dropdownlist
                                                    [data]="committees"
                                                    textField="Name"
                                                    valueField="ID"
                                                    [(ngModel)]="record.CommitteeID"
                                                    [valuePrimitive]="true"
                                                    [defaultItem]="{ ID: null, Name: 'Select committee...' }"
                                                    name="CommitteeID"
                                                    class="form-dropdown">
                                                </kendo-dropdownlist>
                                            }
                                        </div>
                                    } @else {
                                        <div class="field-display">
                                            @if (record.CommitteeID) {
                                                <span class="field-value">{{ record.Committee }}</span>
                                            } @else {
                                                <span class="field-empty">Not linked</span>
                                            }
                                        </div>
                                    }
                                </div>

                                <!-- MeetingID -->
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fas fa-calendar-alt"></i>
                                        Meeting
                                    </label>
                                    @if (EditMode) {
                                        <div class="dropdown-wrapper">
                                            @if (isLoadingMeetings) {
                                                <div class="dropdown-loading">
                                                    <i class="fas fa-spinner fa-spin"></i>
                                                    <span>Loading...</span>
                                                </div>
                                            } @else {
                                                <kendo-dropdownlist
                                                    [data]="meetings"
                                                    textField="Name"
                                                    valueField="ID"
                                                    [(ngModel)]="record.MeetingID"
                                                    [valuePrimitive]="true"
                                                    [defaultItem]="{ ID: null, Name: 'Select meeting...' }"
                                                    name="MeetingID"
                                                    class="form-dropdown">
                                                </kendo-dropdownlist>
                                            }
                                        </div>
                                    } @else {
                                        <div class="field-display">
                                            @if (record.MeetingID) {
                                                <span class="field-value">{{ record.Meeting }}</span>
                                            } @else {
                                                <span class="field-empty">Not linked</span>
                                            }
                                        </div>
                                    }
                                </div>

                                <!-- AgendaItemID -->
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fas fa-list-ol"></i>
                                        Agenda Item
                                    </label>
                                    @if (EditMode) {
                                        <div class="dropdown-wrapper">
                                            @if (isLoadingAgendaItems) {
                                                <div class="dropdown-loading">
                                                    <i class="fas fa-spinner fa-spin"></i>
                                                    <span>Loading...</span>
                                                </div>
                                            } @else {
                                                <kendo-dropdownlist
                                                    [data]="agendaItems"
                                                    textField="Name"
                                                    valueField="ID"
                                                    [(ngModel)]="record.AgendaItemID"
                                                    [valuePrimitive]="true"
                                                    [defaultItem]="{ ID: null, Name: 'Select agenda item...' }"
                                                    name="AgendaItemID"
                                                    class="form-dropdown">
                                                </kendo-dropdownlist>
                                            }
                                        </div>
                                    } @else {
                                        <div class="field-display">
                                            @if (record.AgendaItemID) {
                                                <span class="field-value">{{ record.AgendaItem }}</span>
                                            } @else {
                                                <span class="field-empty">Not linked</span>
                                            }
                                        </div>
                                    }
                                </div>

                                <!-- ActionItemID -->
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fas fa-tasks"></i>
                                        Action Item
                                    </label>
                                    @if (EditMode) {
                                        <div class="dropdown-wrapper">
                                            @if (isLoadingActionItems) {
                                                <div class="dropdown-loading">
                                                    <i class="fas fa-spinner fa-spin"></i>
                                                    <span>Loading...</span>
                                                </div>
                                            } @else {
                                                <kendo-dropdownlist
                                                    [data]="actionItems"
                                                    textField="Name"
                                                    valueField="ID"
                                                    [(ngModel)]="record.ActionItemID"
                                                    [valuePrimitive]="true"
                                                    [defaultItem]="{ ID: null, Name: 'Select action item...' }"
                                                    name="ActionItemID"
                                                    class="form-dropdown">
                                                </kendo-dropdownlist>
                                            }
                                        </div>
                                    } @else {
                                        <div class="field-display">
                                            @if (record.ActionItemID) {
                                                <span class="field-value">{{ record.ActionItem }}</span>
                                            } @else {
                                                <span class="field-empty">Not linked</span>
                                            }
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Metadata Card -->
                    <div class="info-card" [class.edit-mode]="EditMode">
                        <div class="card-header">
                            <div class="card-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                                <i class="fas fa-info-circle"></i>
                            </div>
                            <div class="card-title-section">
                                <h3 class="card-title">Metadata</h3>
                                <p class="card-subtitle">File information</p>
                            </div>
                        </div>

                        <div class="card-body">
                            <!-- MimeType -->
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-file-code"></i>
                                    MIME Type
                                    <span class="optional">(optional)</span>
                                </label>
                                <mj-form-field
                                    [record]="record"
                                    [ShowLabel]="false"
                                    FieldName="MimeType"
                                    Type="textbox"
                                    [EditMode]="EditMode"
                                    [formContext]="formContext">
                                </mj-form-field>
                                <p class="field-hint">e.g., application/pdf, image/png</p>
                            </div>

                            <!-- FileSize -->
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-weight"></i>
                                    File Size
                                    <span class="optional">(bytes)</span>
                                </label>
                                <mj-form-field
                                    [record]="record"
                                    [ShowLabel]="false"
                                    FieldName="FileSize"
                                    Type="textbox"
                                    [EditMode]="EditMode"
                                    [formContext]="formContext">
                                </mj-form-field>
                                @if (record.FileSize) {
                                    <p class="field-hint">{{ fileSizeDisplay }}</p>
                                }
                            </div>

                            <!-- UploadedByUserID -->
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-user-upload"></i>
                                    Uploaded By
                                    <span class="optional">(optional)</span>
                                </label>
                                @if (EditMode) {
                                    <div class="dropdown-wrapper">
                                        @if (isLoadingUsers) {
                                            <div class="dropdown-loading">
                                                <i class="fas fa-spinner fa-spin"></i>
                                                <span>Loading...</span>
                                            </div>
                                        } @else {
                                            <kendo-dropdownlist
                                                [data]="users"
                                                textField="Name"
                                                valueField="ID"
                                                [(ngModel)]="record.UploadedByUserID"
                                                [valuePrimitive]="true"
                                                [defaultItem]="{ ID: null, Name: 'Select user...' }"
                                                name="UploadedByUserID"
                                                class="form-dropdown">
                                            </kendo-dropdownlist>
                                        }
                                    </div>
                                } @else {
                                    <div class="field-display">
                                        @if (record.UploadedByUserID) {
                                            <span class="field-value">{{ record.UploadedByUser }}</span>
                                        } @else {
                                            <span class="field-empty">Not specified</span>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    </div>

                </div>
            </div>

        </form>
    }
</div>
